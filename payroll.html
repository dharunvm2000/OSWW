<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Payroll System (Firebase Compat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f8f9fa; }
  .container { max-width: 1100px; margin-top: 20px; }
  .table-sm td, .table-sm th { padding: .3rem; }
  .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 3000; }
  #loadingOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(255,255,255,0.7); z-index:2000; justify-content:center; align-items:center; }
</style>
</head>
<body class="bg-light">

<div id="loadingOverlay">
  <div class="spinner-border text-primary" style="width:3rem;height:3rem;"></div>
</div>

<div class="container py-3">
  <h2 class="text-center mb-3">Payroll Management</h2>

  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dailyTab">Daily Entry</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dedTab">Deductions</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sumTab">Summary</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#empMgmtTab">Employee Mgmt</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clearTab">Clear Old Entries</a></li>
  </ul>

  <div class="tab-content">

    <!-- DAILY ENTRY -->
    <div class="tab-pane fade show active" id="dailyTab">
      <select id="empName" class="form-select mb-2" onchange="fillDailyPay()"></select>
      <input type="date" id="workDate" class="form-control mb-2">
      
      <!-- Work Type Dropdown + Hours Worked -->
      <div class="input-group mb-2">
        <select id="hoursType" class="form-select" onchange="setHoursWorked()">
          <option value="manual">Manual</option>
          <option value="full">Full Day</option>
          <option value="half">Half Day</option>
          <option value="absent">Absent</option>
        </select>
        <input type="number" id="hoursWorked" step="0.01" class="form-control" placeholder="Hours Worked">
      </div>
      
      <input type="number" id="otHours" step="0.01" class="form-control mb-2" placeholder="OT Hours">
      <input type="number" id="dailyPay" class="form-control mb-2" readonly placeholder="Daily Pay">
      <button class="btn btn-success w-100" onclick="addDailyEntryUI()">Save Entry</button>

      <h5 class="mt-4">Recent Daily Entries</h5>
      <div class="table-responsive">
        <table class="table table-sm table-bordered" id="dailyTable">
          <thead class="table-light">
            <tr><th>Date</th><th>Employee</th><th>Work Type</th><th>Hours</th><th>OT</th><th>Salary</th><th>OT Amt</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-secondary" onclick="loadDailyEntries('prev')">Prev</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadDailyEntries('next')">Next</button>
      </div>
    </div>

    <!-- DEDUCTIONS -->
    <div class="tab-pane fade" id="dedTab">
      <select id="dedEmpName" class="form-select mb-2"></select>
      <input type="date" id="dedDate" class="form-control mb-2">
      <input type="number" id="dedAmount" step="0.01" class="form-control mb-2" placeholder="Deduction Amount">
      <input type="text" id="dedReason" class="form-control mb-2" placeholder="Reason">
      <button class="btn btn-danger w-100" onclick="addDeductionUI()">Add Deduction</button>

      <h5 class="mt-4">Recent Deductions</h5>
      <div class="table-responsive">
        <table class="table table-sm table-bordered" id="dedTable">
          <thead class="table-light">
            <tr><th>Date</th><th>Employee</th><th>Amount</th><th>Reason</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-secondary" onclick="loadDeductionEntries('prev')">Prev</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="loadDeductionEntries('next')">Next</button>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="tab-pane fade" id="sumTab">
      <label>Start Date:</label>
      <input type="date" id="sumStartDate" class="form-control mb-2">
      <label>End Date:</label>
      <input type="date" id="sumEndDate" class="form-control mb-2">
      <button onclick="loadSummaryUI()" class="btn btn-primary w-100 mb-2">Load Summary</button>
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead><tr><th>Emp</th><th>Total Hrs</th><th>OT Hrs</th><th>Salary</th><th>OT</th><th>Deductions</th><th>Net</th><th>Action</th></tr></thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </div>
    </div>

    <!-- EMPLOYEE MANAGEMENT -->
    <div class="tab-pane fade" id="empMgmtTab">
      <h5>Add New Employee</h5>
      <input type="text" id="newEmpName" class="form-control mb-2" placeholder="Employee Name">
      <input type="number" id="newEmpPay" class="form-control mb-2" placeholder="Daily Pay">
      <button class="btn btn-success w-100 mb-3" onclick="addEmployee()">Add Employee</button>
      <h5>Employees</h5>
      <table class="table table-bordered"><thead><tr><th>Name</th><th>Daily Pay</th><th>Actions</th></tr></thead><tbody id="empTableBody"></tbody></table>
    </div>

    <!-- CLEAR -->
    <div class="tab-pane fade" id="clearTab">
      <label>Start Date (earliest entry):</label>
      <input type="date" id="clearStartDate" class="form-control mb-2" disabled>
      <label>End Date:</label>
      <input type="date" id="clearEndDate" class="form-control mb-2">
      <button class="btn btn-danger w-100 mb-2" onclick="clearOldEntries()">Clear Entries</button>
      <div id="clearStatus" class="text-muted"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container">
  <div id="liveToast" class="toast text-white"><div class="d-flex">
    <div class="toast-body" id="toastMsg"></div>
    <button class="btn-close btn-close-white m-auto" data-bs-dismiss="toast"></button>
  </div></div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header">
  <h5 class="modal-title" id="detailsModalTitle"></h5>
  <button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body" id="detailsContent"></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
/* ==== CONFIG ==== */
const firebaseConfig = {
  apiKey: "AIzaSyDdjd5LwyoaUMHmlGGy51z5_56_qUL8Pd0",
  authDomain: "payroll-5649d.firebaseapp.com",
  projectId: "payroll-5649d",
  storageBucket: "payroll-5649d.firebasestorage.app",
  messagingSenderId: "210566811878",
  appId: "1:210566811878:web:6cd0e5db8e623e87d6ab27",
  measurementId: "G-7WJ3S6V1FG"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
let employees=[], toast;
const pageSize=5;

function showToast(msg,type="success"){const t=document.getElementById("liveToast");t.className=`toast align-items-center text-white bg-${type}`;document.getElementById("toastMsg").textContent=msg;if(!toast)toast=new bootstrap.Toast(t,{delay:3000});toast.show();}
function toggleLoading(s){document.getElementById("loadingOverlay").style.display=s?"flex":"none";}
function todayStr(){return new Date().toISOString().split("T")[0];}

/* Attendance Hours Autofill */
function setHoursWorked() {
  let type=document.getElementById("hoursType").value;
  if(type==="full"){hoursWorked.value=8;hoursWorked.readOnly=true;}
  else if(type==="half"){hoursWorked.value=4;hoursWorked.readOnly=true;}
  else if(type==="absent"){hoursWorked.value=0;hoursWorked.readOnly=true;}
  else{hoursWorked.readOnly=false;hoursWorked.value="";}
  fillDailyPay();
}

/* EMPLOYEES */
async function loadEmployees(){
  const snap=await db.collection("employees").orderBy("name").get();
  employees=[];empName.innerHTML="";dedEmpName.innerHTML="";
  snap.forEach(doc=>{employees.push({id:doc.id,...doc.data()});empName.add(new Option(doc.data().name,doc.id));dedEmpName.add(new Option(doc.data().name,doc.id));});
  workDate.value=todayStr();dedDate.value=todayStr();fillDailyPay();
}
function fillDailyPay(){const e=employees.find(x=>x.id===empName.value);dailyPay.value=e?e.dailyPay:"";}
async function addEmployee(){if(!newEmpName.value||!newEmpPay.value)return showToast("Enter name & pay","danger");
  await db.collection("employees").add({name:newEmpName.value.trim(),dailyPay:parseFloat(newEmpPay.value)});showToast("Added");newEmpName.value="";newEmpPay.value="";loadEmployeeList();loadEmployees();}
async function loadEmployeeList(){
  const tb=empTableBody;tb.innerHTML="";const snap=await db.collection("employees").orderBy("name").get();
  snap.forEach(doc=>{const d=doc.data();tb.innerHTML+=`<tr><td><input id="name_${doc.id}" value="${d.name}" class="form-control form-control-sm"></td>
    <td><input id="pay_${doc.id}" value="${d.dailyPay}" type="number" class="form-control form-control-sm"></td>
    <td><button class="btn btn-sm btn-primary" onclick="updateEmployee('${doc.id}')">Save</button>
    <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${doc.id}')">Del</button></td></tr>`;});
}
async function updateEmployee(id){await db.collection("employees").doc(id).update({name:document.getElementById(`name_${id}`).value.trim(),dailyPay:parseFloat(document.getElementById(`pay_${id}`).value)});showToast("Updated");loadEmployees();}
async function deleteEmployee(id){if(confirm("Delete?")){await db.collection("employees").doc(id).delete();showToast("Deleted");loadEmployeeList();loadEmployees();}}

/* DAILY ENTRIES */
let dailyLastDoc=null,dailyPage=[],dailyPageIndex=0;
async function loadDailyEntries(direction){toggleLoading(true);
  let q=db.collection("payroll").orderBy("date","desc").limit(pageSize);
  if(direction==="next"&&dailyLastDoc)q=q.startAfter(dailyLastDoc);
  if(direction==="prev"&&dailyPageIndex>0){dailyPageIndex--;const prev=dailyPage[dailyPageIndex];if(prev)q=db.collection("payroll").orderBy("date","desc").startAt(prev).limit(pageSize);}
  const snap=await q.get();if(snap.empty){toggleLoading(false);return;}
  dailyFirstDoc=snap.docs[0];dailyLastDoc=snap.docs[snap.docs.length-1];
  if(direction!=="prev"){dailyPage[dailyPageIndex]=dailyFirstDoc;dailyPageIndex++;}
  const tb=document.querySelector("#dailyTable tbody");tb.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();const emp=employees.find(e=>e.id===d.employeeId);
    const wtOptions=`
      <select id="workType_${doc.id}" class="form-select form-select-sm" onchange="setHoursFromTable('${doc.id}')">
        <option value="manual"${(d.attendanceType||'manual')==='manual'?' selected':''}>Manual</option>
        <option value="full"${d.attendanceType==='full'?' selected':''}>Full Day</option>
        <option value="half"${d.attendanceType==='half'?' selected':''}>Half Day</option>
        <option value="absent"${d.attendanceType==='absent'?' selected':''}>Absent</option>
      </select>`;
    tb.innerHTML+=`<tr>
      <td><input type="date" class="form-control form-control-sm" value="${d.date}" id="date_${doc.id}"></td>
      <td>${emp?emp.name:d.employeeId}</td>
      <td>${wtOptions}</td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${d.hoursWorked}" id="hours_${doc.id}"></td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${d.otHours}" id="ot_${doc.id}"></td>
      <td>${d.salaryAmt.toFixed(2)}</td>
      <td>${d.otAmt.toFixed(2)}</td>
      <td><button class="btn btn-sm btn-primary" onclick="updateDailyEntry('${doc.id}')">Save</button>
          <button class="btn btn-sm btn-danger" onclick="deleteDailyEntry('${doc.id}')">Del</button></td>
    </tr>`;
  });
  toggleLoading(false);
}
function setHoursFromTable(id){
  const type=document.getElementById(`workType_${id}`).value;
  const hrsInput=document.getElementById(`hours_${id}`);
  if(type==="full"){hrsInput.value=8;hrsInput.readOnly=true;}
  else if(type==="half"){hrsInput.value=4;hrsInput.readOnly=true;}
  else if(type==="absent"){hrsInput.value=0;hrsInput.readOnly=true;}
  else{hrsInput.readOnly=false;}
}
async function addDailyEntryUI(){
  const emp=employees.find(e=>e.id===empName.value);if(!emp)return showToast("No employee","danger");
  const hours=+hoursWorked.value||0;const ot=+otHours.value||0;
  await db.collection("payroll").add({
    employeeId:empName.value,date:workDate.value,hoursWorked:hours,otHours:ot,
    attendanceType:document.getElementById("hoursType").value,
    salaryAmt:(hours*emp.dailyPay)/8,otAmt:(ot*emp.dailyPay)/8
  });
  showToast("Daily saved");loadDailyEntries();
}
async function updateDailyEntry(id){
  const hours=parseFloat(document.getElementById(`hours_${id}`).value)||0;
  const ot=parseFloat(document.getElementById(`ot_${id}`).value)||0;
  const date=document.getElementById(`date_${id}`).value;
  const snap=await db.collection("payroll").doc(id).get();const data=snap.data();
  const emp=employees.find(e=>e.id===data.employeeId);
  let attType=document.getElementById(`workType_${id}`).value;
  await db.collection("payroll").doc(id).update({
    date,hoursWorked:hours,otHours:ot,attendanceType:attType,
    salaryAmt:(hours*emp.dailyPay)/8,otAmt:(ot*emp.dailyPay)/8
  });
  showToast("Updated");loadDailyEntries();
}
async function deleteDailyEntry(id){if(confirm("Delete?")){await db.collection("payroll").doc(id).delete();showToast("Deleted","warning");loadDailyEntries();}}

/* Deductions same as before */
let dedLastDoc=null,dedPage=[],dedPageIndex=0;
async function loadDeductionEntries(direction){toggleLoading(true);
  let q=db.collection("deductions").orderBy("date","desc").limit(pageSize);
  if(direction==="next"&&dedLastDoc)q=q.startAfter(dedLastDoc);
  if(direction==="prev"&&dedPageIndex>0){dedPageIndex--;const prev=dedPage[dedPageIndex];if(prev)q=db.collection("deductions").orderBy("date","desc").startAt(prev).limit(pageSize);}
  const snap=await q.get();if(snap.empty){toggleLoading(false);return;}
  dedFirstDoc=snap.docs[0];dedLastDoc=snap.docs[snap.docs.length-1];
  if(direction!=="prev"){dedPage[dedPageIndex]=dedFirstDoc;dedPageIndex++;}
  const tb=document.querySelector("#dedTable tbody");tb.innerHTML="";
  snap.forEach(doc=>{const d=doc.data();const emp=employees.find(e=>e.id===d.employeeId);
    tb.innerHTML+=`<tr>
      <td><input type="date" class="form-control form-control-sm" value="${d.date}" id="ded_date_${doc.id}"></td>
      <td>${emp?emp.name:d.employeeId}</td>
      <td><input type="number" step="0.01" class="form-control form-control-sm" value="${d.amount}" id="ded_amt_${doc.id}"></td>
      <td><input type="text" class="form-control form-control-sm" value="${d.reason}" id="ded_reason_${doc.id}"></td>
      <td><button class="btn btn-sm btn-primary" onclick="updateDeduction('${doc.id}')">Save</button>
          <button class="btn btn-sm btn-danger" onclick="deleteDeduction('${doc.id}')">Del</button></td>
    </tr>`;});
  toggleLoading(false);
}
async function addDeductionUI(){
  await db.collection("deductions").add({employeeId:dedEmpName.value,date:dedDate.value,amount:+dedAmount.value||0,reason:dedReason.value||""});
  showToast("Deduction added","warning");loadDeductionEntries();}
async function updateDeduction(id){
  await db.collection("deductions").doc(id).update({
    date:document.getElementById(`ded_date_${id}`).value,
    amount:parseFloat(document.getElementById(`ded_amt_${id}`).value)||0,
    reason:document.getElementById(`ded_reason_${id}`).value.trim()});
  showToast("Updated");loadDeductionEntries();}
async function deleteDeduction(id){if(confirm("Delete?")){await db.collection("deductions").doc(id).delete();showToast("Deleted","warning");loadDeductionEntries();}}

/* Summary + Details */
async function loadSummaryUI(){const s=sumStartDate.value,e=sumEndDate.value;if(!s||!e)return showToast("Select dates","danger");
  const paySnap=await db.collection("payroll").where("date",">=",s).where("date","<=",e).get(),summary={},dedMap={};
  paySnap.forEach(doc=>{const d=doc.data();if(!summary[d.employeeId])summary[d.employeeId]={h:0,o:0,sal:0,ot:0};
    summary[d.employeeId].h+=d.hoursWorked;summary[d.employeeId].o+=d.otHours;summary[d.employeeId].sal+=d.salaryAmt;summary[d.employeeId].ot+=d.otAmt;});
  const dedSnap=await db.collection("deductions").where("date",">=",s).where("date","<=",e).get();
  dedSnap.forEach(doc=>{const d=doc.data();dedMap[d.employeeId]=(dedMap[d.employeeId]||0)+d.amount;});
  summaryBody.innerHTML="";for(let id in summary){const emp=employees.find(e=>e.id===id),ded=dedMap[id]||0,net=summary[id].sal+summary[id].ot-ded;
    summaryBody.innerHTML+=`<tr><td>${emp?emp.name:id}</td><td>${summary[id].h}</td><td>${summary[id].o}</td><td>${summary[id].sal.toFixed(2)}</td>
    <td>${summary[id].ot.toFixed(2)}</td><td>${ded.toFixed(2)}</td><td>${net.toFixed(2)}</td>
    <td><button class="btn btn-sm btn-outline-primary" onclick="showDetails('${id}','${s}','${e}')">Details</button></td></tr>`;}
}
async function showDetails(id,s,e){const emp=employees.find(x=>x.id===id);if(!emp)return showToast("No emp","danger");
  const map={},paySnap=await db.collection("payroll").where("employeeId","==",id).where("date",">=",s).where("date","<=",e).orderBy("date").get();
  let th=0,to=0,ts=0,toa=0,td=0,absentDays=0;
  paySnap.forEach(doc=>{const d=doc.data();map[d.date]={h:d.hoursWorked,o:d.otHours,sal:d.salaryAmt,otA:d.otAmt,ded:0};
    th+=d.hoursWorked;to+=d.otHours;ts+=d.salaryAmt;toa+=d.otAmt;
    if(d.attendanceType==="absent"||d.hoursWorked===0) absentDays++;
  });
  const dedSnap=await db.collection("deductions").where("employeeId","==",id).where("date",">=",s).where("date","<=",e).orderBy("date").get();
  dedSnap.forEach(doc=>{const d=doc.data();if(!map[d.date])map[d.date]={h:0,o:0,sal:0,otA:0,ded:0};map[d.date].ded+=d.amount;td+=d.amount;});
  let html=`<table class="table table-sm table-bordered table-striped text-center"><thead class="table-dark"><tr><th>Date</th><th>Hours Worked</th><th>OT Hours</th><th>Deductions</th></tr></thead><tbody>`;
  Object.keys(map).sort().forEach(dt=>{html+=`<tr><td>${dt}</td><td><strong>${map[dt].h}</strong></td><td><strong>${map[dt].o}</strong></td><td class="text-danger"><strong>${map[dt].ded.toFixed(2)}</strong></td></tr>`;});
  html+=`</tbody></table><hr>
         <p><b>Total Hours Worked:</b> <span class="fw-bold text-primary">${th}</span> → <span class="fw-bold text-success">₹${ts.toFixed(2)}</span></p>
         <p><b>Total OT Hours:</b> <span class="fw-bold text-primary">${to}</span> → <span class="fw-bold text-success">₹${toa.toFixed(2)}</span></p>
         <p><b>Total Deductions:</b> <span class="fw-bold text-danger">₹${td.toFixed(2)}</span></p>
         <p><b>Absent Days:</b> <span class="fw-bold text-danger">${absentDays}</span></p>
         <p><b>Net Salary:</b> <span class="fw-bold text-success">₹${(ts+toa-td).toFixed(2)}</span></p>`;
  detailsModalTitle.textContent=`Payroll Details of ${emp.name} (${s} to ${e})`;
  detailsContent.innerHTML=html;new bootstrap.Modal(detailsModal).show();
}

/* Clear Old Entries same as before */
async function setEarliestDate(){const ps=await db.collection("payroll").orderBy("date").limit(1).get(),ds=await db.collection("deductions").orderBy("date").limit(1).get();
  let pd=ps.empty?null:ps.docs[0].data().date,dd=ds.empty?null:ds.docs[0].data().date;
  let earliest=pd&&dd?(pd<dd?pd:dd):(pd||dd);if(earliest){clearStartDate.value=earliest;clearEndDate.min=earliest;clearEndDate.value=earliest;}else clearStatus.textContent="No entries";}
async function batchDeleteInRange(col,s,e){let q=db.collection(col).where("date",">=",s).where("date","<=",e),tot=0;while(true){
  const snap=await q.limit(500).get();if(snap.empty)break;let b=db.batch();snap.docs.forEach(doc=>b.delete(doc.ref));await b.commit();tot+=snap.size;
  if(snap.size<500)break;}}
async function clearOldEntries(){if(!clearEndDate.value)return showToast("Select end date","danger");
  const s=clearStartDate.value,e=clearEndDate.value;if(e<s)return showToast("End < start","danger");await batchDeleteInRange("payroll",s,e);
  await batchDeleteInRange("deductions",s,e);showToast("Entries cleared");setEarliestDate();}

/* Init */
loadEmployees();
document.querySelector('a[href="#dailyTab"]').addEventListener("shown.bs.tab",()=> loadDailyEntries());
document.querySelector('a[href="#dedTab"]').addEventListener("shown.bs.tab",()=> loadDeductionEntries());
document.querySelector('a[href="#empMgmtTab"]').addEventListener("shown.bs.tab",loadEmployeeList);
document.querySelector('a[href="#clearTab"]').addEventListener("shown.bs.tab",setEarliestDate);
</script>
</body>
</html>
